#!/bin/dash

# /usr/sbin/hpm-install: a package installer
# dependencies: dash, XZ Utils and roar-ng II

# the command-line usage message
USAGE="hpm-install PACKAGE NAME

Install a software package."

# check the command-line arguments
if [ 2 -ne $# ] || [ ! -f "$1" ] || [ -z "$2" ]
then
	echo "$USAGE"
	exit 1
fi

# include roar-ng, for execute_and_delete_script() and print_error()
. /usr/bin/roar-ng

# include the configuration file
. /etc/hpmrc

# make sure the package is not installed already
if [ -f "$PKG_DATA_DIR/$2" ]
then
	print_error "the package is already installed"
	exit 1
fi

# create a temporary directory for the package extraction
temp_dir="$(mktemp -d)"

# exctract the package to the temporary directory
echo -n "Extracting the package ..."
tar -xJf "$1" -C $temp_dir
if [ 0 -ne $? ]
then
	rm -rf $temp_dir
	print_error "failed to extract the package"
	exit 1
fi
echo " done"

# install the package files
echo -n "Installing files ..."
cp -rf $temp_dir/* /
if [ 0 -ne $? ]
then
	rm -rf $temp_dir
	print_error "failed to install the package files"
	exit 1
fi
echo " done"

# run the post-install script
if [ -f /post_install.sh ]
then
	execute_and_delete_script /post_install.sh
	[ 0 -ne $? ] && exit 1
fi

# if there is a post-removal script, keep it, so hpm-remove can run it once the
# package is removed
[ -f /post_uninstall.sh ] && \
                      mv /post_uninstall.sh "$PKG_DATA_DIR/$2-post_uninstall.sh"

# list the package contents
echo -n "Registering the package ..."
find $temp_dir -mindepth 1 | sed s~"$temp_dir"~~g > "$PKG_DATA_DIR/$2"
echo " done"

rm -rf $temp_dir
